---
title: 第十二章- 非阻塞通信MPI程序设计
date: 2021-06-011
categories:
 - HPC
tags:
 - MPI
sidebar: 'auto'
---

## 阻塞通信

从程序员的角度看, 当一个阻塞通信正确返回后, 其后果是:
 1. 该调用要求的通信操作已正确完成, 即消息已成功发出或成功接收 
 2. 该调用的缓冲区可用, 若是发送操作, 则该缓冲区可以被其它的操作更新; 若是接收操作, 该缓冲区中的数据已经完整, 可以被正确引用

在阻塞通信中, 对于接收进程, 在接收消息时, 除了要求接收到的消息的消息信封和接
收操作自身的消息信封相一致外, 还要求它接收到的消息是最早发送给自己的消息. 若两个
消息的消息信封都和自己的消息信封吻合, 则必须先接收首先发送的消息, 哪怕后发送的消
息首先到达, 该接收操作也必须等待第一个消息.

如图所示, 进程0先后发送两条消息给进程1, 进程1的第一个接收语句可以与任何一
个发送语句的消息相匹配. 但是, 根据有序接收的语义约束, 由进程0发送的第一个消息必
须被进程0的第一个接收语句接收, 而由进程0发送的第二个消息必须被进程1的第二个接收语
句接收. 如果进程0的第一个消息先到达, 进程1的第一条接收语句也不能接收它.

## 非阻塞通信简介

MPI提供的非阻塞通信调用的函数十分丰富, 所有阻塞通信的形式都有相应的非阻塞通
信的形式. 

由于通信经常需要较长的时间, 在阻塞通信还没有结束的时候, 处理机只能等待. 这样
就浪费了处理机的计算资源. 一种常见的技术就是设法使计算与通信重叠, 非阻塞通信可以
实现这一目的. 非阻塞通信主要用于计算和通信的重叠从, 而提高整个程序执行的效率.此外, 
非阻塞通信还可以实现一些特殊的控制功能. 

对于非阻塞通信, 不必等到通信操作完全完成便可以返回, 该通信操作可以交给特定的
通信硬件去完成. 在该通信硬件完成该通信操作的同时, 处理机可以同时进行计算操作, 这
样便实现了计算与通信的重叠. 通过计算与通信的重叠, 可以大大提高程序执行的效率, 这
一方法和通过异步I/O实现I/O与计算的重叠思路是完全一样的. 

当然, 由于当非阻塞通信调用返回时一般该通信操作还没有完成, 因此对于非阻塞的发
送操作, 发送缓冲区必须等到发送完成后才能释放. 这样便需要引入新的手段(非阻塞通信完成对象)让程序员知道什么时候该消息已成功发送. 同样, 对于非阻塞的接收操作, 该调
用返回后并不意味着接收消息已全部到达, 必须等到消息到达后才可以引用接收到的消息数据.

从上可以看出, 对于阻塞通信, 只需要一个调用函数即可以完成, 但是对于非阻塞通信
一般需要两个调用函数, 首先是非阻塞通信的"启动"但启动并不意味着该通信过程的完
成, 因此, 为了保证通信的完成, 还必须调用与该通信相联系的通信"完成"调用接口, 通
信完成调用才真正将非阻塞通信完成.

非阻塞通信和四种通信模式相结合, 可以有四类不同的形式. 针对某些通信是在一个循
环中重复执行的情况, 为了进一步提供优化的可能和提高效率, MPI又引入了重复非阻塞通
信方式. 对于重复非阻塞通信, 和四种通信模式相结合, 又有四种不同的具体形式.

各种非阻塞通信形式, 其效果都是将非阻塞通信的基本特征和具体的通信模式相结合后
的综合体现. 比如非阻塞缓存发送就是非阻塞+缓存的结果.

由于非阻塞通信返回后并不意味着通信的完成, MPI还提供了各种非阻塞通信的完成方
法和完成检测方法. MPI可以一次完成一个非阻塞通信, 也可以一次完成所有的非阻塞通信
还可以一次完成任意一个或任意多个非阻塞调用, 对于非阻塞通信是否完成的检测也有以上
各种形式.


|通信模式   |          |发送  |接受  |
|:---------:|---------|---------|---------|
|标准通信模式     |   |    MPI_ISEND   |    MPI_IRECV     |         
|缓存同步模式     |   |  MPI_IBSEND    |         |         
|同步通信模式     |   | MPI_ISSEND     |         |         
|就绪通信模式     |   | MPI_IRSEND     |         |         
|         |  标准通信模式        |     MPI_SEND_INIT    |     MPI_RECV_INIT    |
|  重复     |    缓存同步模式     |     MPI_IBSEND_INIT    |         |
| 非阻塞通信   |    同步通信模式     |     MPI_ISSEND_INIT    |         |
|         |     就绪通信模式    |     MPI_IRSEND_INIT    |         |


|非阻塞通信的数量  |检测  |完成  |
|---------|---------|---------|
|一个非阻塞通信     |     MPI_TEST    |     MPI_WAIT    |
|任意一个非阻塞通信    |    MPI_TESTANY     |   MPI_WAITANY      |
|一到多个非阻塞通信     |  MPI_TESTSOME       |   MPI_WAITSOME      |
|所有非阻塞通信   |     MPI_TESTALL    |   MPI_WAITALL      |

